---
# tasks file for frontend

- name: Install frontend packages
  apt:
    name: "{{ frontend_packages }}"
    state: present

- name: Create frontend application directory
  file:
    path: "{{ frontend_app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Ensure web server is running
  service:
    name: "{{ web_server_package }}"
    state: started
    enabled: true

- name: Add NodeSource repository for Node.js 18.x
  shell: |
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  args:
    executable: /bin/bash
    creates: /etc/apt/sources.list.d/nodesource.list

- name: Install Node.js (includes npm)
  apt:
    name: nodejs
    state: present
    update_cache: yes

- name: Create home directory for taskapp user
  file:
    path: /home/{{ app_user }}
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  become: true

- name: Create npm cache directory
  file:
    path: "{{ app_base_dir }}/.npm"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  become: true

- name: Clone frontend repository
  git:
    repo: "{{ frontend_repo_url }}"
    dest: "{{ frontend_src_dir }}"
    version: "{{ frontend_branch }}"
    force: yes
  become_user: "{{ app_user }}"
  become: true

- name: Create frontend .env.production file
  copy:
    dest: "{{ frontend_src_dir }}/.env.production"
    content: |
      VITE_API_URL=http:/api
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0644'
  become: true

- name: Install frontend dependencies
  command: npm install
  args:
    chdir: "{{ frontend_src_dir }}"
  environment:
    npm_config_cache: "{{ app_base_dir }}/.npm"
  become_user: "{{ app_user }}"
  become: true

- name: Build frontend application
  command: npm run build
  args:
    chdir: "{{ frontend_src_dir }}"
  environment:
    npm_config_cache: "{{ app_base_dir }}/.npm"
  become_user: "{{ app_user }}"
  become: true

# ────────────────────────────────────────────────
# Nginx deployment section – improved for reliability
# ────────────────────────────────────────────────

- name: Ensure nginx root directory exists with correct permissions
  file:
    path: "{{ frontend_nginx_root }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- name: Clean previous frontend build artifacts
  file:
    path: "{{ frontend_nginx_root }}"
    state: absent
  notify: Restart nginx

- name: Recreate nginx root directory after cleanup
  file:
    path: "{{ frontend_nginx_root }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  notify: Restart nginx

- name: Deploy frontend build artifacts
  copy:
    src: "{{ frontend_build_dir }}/"
    dest: "{{ frontend_nginx_root }}/"
    owner: www-data
    group: www-data
    mode: '0644'
    remote_src: yes
  notify: Restart nginx

- name: Ensure all directories in nginx root are traversable
  file:
    path: "{{ frontend_nginx_root }}"
    state: directory
    mode: '0755'
    recurse: yes
  notify: Restart nginx

- name: Ensure all files in nginx root are readable
  command: find {{ frontend_nginx_root }} -type f -exec chmod 644 {} \;
  changed_when: false
  notify: Restart nginx

- name: Install nginx config
  template:
    src: taskapp-nginx.conf.j2
    dest: /etc/nginx/sites-available/taskapp
    mode: '0644'
  notify: Restart nginx

- name: Remove default nginx site (prevents conflict)
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Restart nginx

- name: Enable custom taskapp site
  file:
    src: /etc/nginx/sites-available/taskapp
    dest: /etc/nginx/sites-enabled/taskapp
    state: link
    force: yes   # overwrite if broken link exists
  notify: Restart nginx

- name: Validate nginx configuration before restart
  command: nginx -t
  changed_when: false
  notify: Restart nginx
